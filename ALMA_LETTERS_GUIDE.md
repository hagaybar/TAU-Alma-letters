# Alma Letters Configuration Guide

## Overview

Alma's letter system enables institutions to send customizable messages to patrons, librarians, and vendors through multiple channels including email, SMS, ISO protocol, print, and external systems. Letters are constructed by combining three core elements:

1. **Dynamic XML fields** - Generated by Alma with transaction/patron/item data
2. **Labels** - Static text (field names, descriptions, messages)
3. **Templates** - XSL stylesheets for formatting and logic

## Required Permissions

To configure Alma letters, you need one of these roles:
- General System Administrator
- Letter Administrator

## Letter Components

### 1. XML Data Structure

All dynamic data is contained within the `/notification_data/` root element. Common XML paths include:

#### General Data
- `/notification_data/general_data/` - Letter metadata, dates, identifiers
- `/notification_data/languages/string` - Language code (e.g., 'he', 'en')
- `/notification_data/receivers/receiver/user/user_preferred_language` - Patron language preference

#### User Information
- `/notification_data/receivers/receiver/user/last_name` - Patron last name
- `/notification_data/receivers/receiver/user/first_name` - Patron first name
- `/notification_data/receivers/receiver/user/user_email/email` - Patron email
- `/notification_data/receivers/receiver/user/user_group` - User group code
- `/notification_data/receivers/receiver/user/original_id` - Primary identifier
- `/notification_data/user_for_printing/` - Alternative user data node

#### Item Information
- `/notification_data/phys_item_display/title` - Bibliographic title
- `/notification_data/phys_item_display/author` - Author name
- `/notification_data/phys_item_display/issue_level_description` - Volume/issue details
- `/notification_data/phys_item_display/barcode` - Item barcode
- `/notification_data/phys_item_display/call_number` - Call number
- `/notification_data/item/library_name` - Owning library
- `/notification_data/metadata/title` - Alternative title path

#### Loan Information
- `/notification_data/loans_by_library/library_loans_for_display` - Loan records grouped by library
- `/notification_data/item_loans/item_loan` - Individual loan records
- `/notification_data/item_loans/item_loan/library_name` - Loan library
- `/notification_data/item_loans/item_loan/due_date` - Due date

#### Library/Organization
- `/notification_data/organization_unit/name` - Library name
- `/notification_data/organization_unit/address/` - Library address components
- `/notification_data/organization_unit/phone/phone` - Library phone
- `/notification_data/organization_unit/email/email` - Library email
- `/notification_data/organization_unit/org_scope/library_id` - Library identifier
- `/notification_data/library/name` - Alternative library name path
- `/notification_data/library/org_scope/library_id` - Alternative library ID path

#### Resource Sharing
- `/notification_data/request/resource_sharing_request_id` - RS request identifier (presence indicates RS letter)
- `/notification_data/incoming_request/format` - Request format (e.g., 'PHYSICAL')
- `/notification_data/incoming_request/library_id` - Requesting library ID

#### Request Information
- `/notification_data/request/work_flow_entity/expiration_date` - Hold expiration date
- `/notification_data/request/system_notes` - System-generated notes

### 2. Labels (Static Text)

Labels are static text strings managed through Alma's administrative interface. They appear in templates as `@@label_name@@` placeholders, which Alma replaces with the configured text at runtime.

**Common Label Uses:**
- Field headers (e.g., `@@title@@`, `@@author@@`, `@@due_date@@`)
- Message text (e.g., `@@dear@@`, `@@sincerely@@`, `@@message@@`)
- Instructions (e.g., `@@note_item_held_until@@`, `@@following_item_requested_on@@`)

**Advantages:**
- No XSLT knowledge required
- Multi-language support
- Centralized text management
- No template editing needed

**Customization:**
- Configure through Admin → General Configuration → Configure Letters
- Can include Request ID in subject lines via label configuration
- Support for multiple language sets

### 3. XSL Templates

XSL stylesheets transform XML data into HTML output. Templates support:

#### Output Formatting
- Extract specific data portions (e.g., last four digits of a code)
- Format dates, numbers, currency
- Construct tables and lists

#### Conditional Logic
- Display content based on patron data, user groups, or transaction details
- Suppress sections for specific conditions
- Implement library-specific variations

#### Dynamic Content
- Add vendor notes, rush indicators, phone numbers
- Include calculated values
- Generate context-specific messages

## Configuration Methods

### Method 1: Label Configuration (No Coding)

**When to Use:**
- Simple text changes
- Field name customization
- Multi-language translations

**How to Configure:**
1. Navigate to Admin → General Configuration → Configure Letters
2. Select letter type
3. Edit labels in the Labels tab
4. Save changes

### Method 2: Template Customization (XSLT)

**When to Use:**
- Advanced formatting requirements
- Conditional content display
- Element removal/addition
- Group-based letter suppression
- Complex data extraction

**How to Customize:**
1. Navigate to Admin → General Configuration → Configure Letters
2. Select letter type
3. Switch to Template tab (XSL editor)
4. Edit XSLT code
5. Use preview pane to test changes
6. Save when complete

## Testing and Deployment

### Built-in Preview

The Alma configuration interface provides:
- **XML pane** - Shows sample notification data
- **XSL pane** - Template editor with syntax highlighting
- **Preview pane** - Real-time HTML output
- **Error detection** - Red X markers on problematic lines

**Best Practice:** Changes in XSL/XML are immediately reflected in preview pane. Always preview before saving.

### Obtaining XML Samples

**Current Method (as of March 2021):**
Alma includes built-in functionality to generate XML samples directly within the letter configuration interface.

**How to Access:**
1. Open letter configuration
2. View XML tab to see sample data structure
3. Use actual XML for development/testing

**Note:** Legacy external XML sample files are deprecated. Use Alma's native XML generation instead.

### Example Letters

Alma provides example letters for each letter type to enable testing before production deployment. Use these templates for:
- Understanding default structure
- Validation before going live
- Reference for customization

### Quick Printing

Any letter configured for printer/email output can be printed via Quick Printing functionality for testing.

## XSLT Best Practices

### 1. Incremental Troubleshooting

When troubleshooting heavily customized stylesheets:
- Eliminate one condition/test/section at a time
- Isolate the problematic code
- Test after each change

**Rationale:** Ex Libris Support assists with customized XSL issues within practical limits, but heavily customized stylesheets may require time-consuming analysis beyond support scope.

### 2. Template Reference Validation

**Critical Rule:** XSLT processing will **fail** if a file contains `xsl:call-template` statements referencing non-existent templates, **even if the code is unused**.

**Prevention:**
- Remove unused template calls
- Verify all `xsl:include` files exist
- Ensure included files contain referenced templates

### 3. Component Reuse

**Shared Components** can be configured once and applied across multiple letters.

**Benefits:**
- Reduced maintenance overhead
- Consistent styling across letters
- Centralized updates

**Caution:** Changes to components affect **all** letters using that component. Review carefully before saving.

**Configuration:**
Admin → General Configuration → Configure Components

### 4. Error Handling

- Red X markers indicate syntax/logic errors
- Preview pane displays rendering issues
- Test with multiple scenarios (different languages, libraries, patron types)

### 5. Version Control

**Recommendation:** Maintain XSL templates in Git repository (like this one) for:
- Change tracking
- Rollback capability
- Collaboration
- Documentation

## Email Configuration

### From Address

Set via:
1. `addressFrom` label in letter configuration, OR
2. Library preferred email address

### Envelope From

Configure through Integration Profiles for:
- DKIM compliance
- Mail relay best practices
- Bounce handling

### Channels

Letters support multiple delivery channels:
- Email
- SMS
- Print
- ISO protocol
- External systems

## Advanced Features

### Letter Retention Policies

Administrators can set retention policies for generated letters to manage storage and compliance requirements.

### Enable/Disable Control

Individual letters can be enabled or disabled without deletion, allowing temporary suspension of specific notifications.

### Multi-Language Support

- Configure separate label sets for each language
- Use conditional logic in templates for language-specific content
- Default language fallback for undefined translations

### Request ID in Subject Lines

Include Request IDs in email subject lines via label configuration for easier patron tracking and support.

## Common Customization Examples

### Example 1: Conditional Content Display

```xml
<xsl:choose>
    <xsl:when test="/notification_data/request/resource_sharing_request_id != ''">
        <!-- Resource sharing letter content -->
        <xsl:call-template name="rs_specific_template" />
    </xsl:when>
    <xsl:otherwise>
        <!-- Regular letter content -->
        <xsl:call-template name="standard_template" />
    </xsl:otherwise>
</xsl:choose>
```

### Example 2: Suppress Letters for Specific User Groups

```xml
<xsl:if test="not(/notification_data/receivers/receiver/user/user_group = 'EXCLUDE_GROUP')">
    <!-- Letter content only displays if user is NOT in EXCLUDE_GROUP -->
</xsl:if>
```

### Example 3: Library-Specific Variations

```xml
<xsl:choose>
    <xsl:when test="/notification_data/organization_unit/org_scope/library_id = '190905450004146'">
        <!-- Wiener Library specific content -->
    </xsl:when>
    <xsl:otherwise>
        <!-- Default content -->
    </xsl:otherwise>
</xsl:choose>
```

### Example 4: Extract Partial Data

```xml
<!-- Display last 4 digits of barcode -->
<xsl:value-of select="substring(/notification_data/phys_item_display/barcode, string-length(/notification_data/phys_item_display/barcode) - 3)" />
```

### Example 5: Bilingual Content

```xml
<xsl:choose>
    <xsl:when test="/notification_data/receivers/receiver/user/user_preferred_language = 'he'">
        <xsl:text>שלום</xsl:text>
    </xsl:when>
    <xsl:otherwise>
        <xsl:text>Hello</xsl:text>
    </xsl:otherwise>
</xsl:choose>
```

## Common Letter Types

Alma supports 59+ letter categories, including:

### Patron Notifications
- Overdue notices
- Fine/fee statements
- Hold pickup notifications
- Due date reminders
- Courtesy notices
- Receipt confirmations

### Resource Sharing
- Borrowing requests
- Lending confirmations
- Shipping slips
- Return slips
- ILL notifications

### Administrative
- Order confirmations
- Subscription renewals
- Export reports
- System-generated messages
- Staff notifications

### Digitization
- Document delivery notifications
- Digitization request confirmations

## Resources

### Official Documentation
- **Alma Online Help**: [Configuring Alma Letters](https://knowledge.exlibrisgroup.com/Alma/Product_Documentation/010Alma_Online_Help_(English)/050Administration/050Configuring_General_Alma_Functions/070Configuring_Alma_Letters)
- **Configuring Components**: [Reusing Components Across Letters](https://knowledge.exlibrisgroup.com/Alma/Product_Documentation/010Alma_Online_Help_(English)/050Administration/050Configuring_General_Alma_Functions/190Configuring_Components)

### Community Resources
- **Ex Libris Developer Network**: Technical blogs and examples
- **GitHub Repositories**: Other institutions' customizations (CSU-ULMS, UiO, Bisentralen)
- **CARLI Documentation**: Editing greetings, preferred names, letter content

### Support
- Ex Libris Support assists with customized XSL issues within practical limits
- Community forums and listservs
- Institutional consortia knowledge bases

## Troubleshooting Checklist

- [ ] Red X errors resolved in XSL editor
- [ ] Preview pane displays correctly
- [ ] All `xsl:include` references valid
- [ ] All `xsl:call-template` references exist
- [ ] Tested with multiple languages
- [ ] Tested with different libraries/locations
- [ ] Tested with different patron types
- [ ] XML sample data matches production structure
- [ ] Labels configured for all languages
- [ ] Component changes reviewed for impact
- [ ] Version controlled in Git
- [ ] Backup of previous version saved
- [ ] Stakeholders reviewed output
- [ ] Documentation updated

## Migration Notes

When upgrading Alma or migrating letters:
1. Export current XSL templates to Git repository
2. Review Alma release notes for letter changes
3. Test customizations against new XML structure
4. Update deprecated XPath references
5. Verify component compatibility
6. Re-test all conditional logic
7. Deploy incrementally by letter type
8. Monitor for rendering issues post-deployment
